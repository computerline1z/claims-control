// Generated by CoffeeScript 1.4.0
(function() {
  var $ = window.jQuery;

  $.widget("ui.UploadFiles", {
    options: {
      uploadTemplateId: "tmp2templateUpload",
      downloadTemplateId: "tmp2templateDownload",
      formTemplate: "tmpUploadForm",
      docsController: "TreeDocController",
      url: "Files/Start",
      fileuploaddone: function() {
        return console.log("opa");
      },
      categoryOpts: {
        editList: true
      },
      ListType: "List",
      Source: "tblDocTypes",
      iVal: "iD",
      iText: ["name"]
    },
    _create: function() {
      Em.View.create({
        templateName: this.options.formTemplate
      }).appendTo(this.element);
      return Em.run.next(this, function() {
        var form;
        form = this.element.find("form").data("opts", this.options);
        return form.fileupload(this.options).bind('fileuploadadded', function(e, data) {
          var inputCat, opts, tr;
          tr = data.context;
          data.form.find(".submitButtons").removeClass("hidden");
          inputCat = tr.find("input[name='category[]']");
          opts = data.form.data("opts");
          if (data.paramName = "docs[]") {
            return inputCat.ComboBoxCategory(opts);
          } else {
            return console.log("paveikslai");
          }
        }).bind("fileuploadadd", function(e, data) {
          var ext;
          data.files[0].paramName = data.paramName;
          ext = data.files[0].name.split('.').pop().substring(0, 3);
          if (ext === "xls" || ext === "doc" || ext === "pdf") {
            data.files[0].extension = ext;
          } else {
            data.files[0].extension = "unknown";
          }
          return data.files[0].type2 = data.files[0].type.split("/")[0];
        }).bind("fileuploadsubmit", function(e, data) {
          var GroupID, RefID, catInput, f, optsAccident, tr;
          tr = data.context;
          f = data.files[0];
          optsAccident = data.form.data("opts").categoryOpts.accident;
          catInput = tr.find("input[name='category[]']");
          GroupID;

          RefID = catInput.data("refID");
          RefID = RefID ? RefID : null;
          if (catInput.length) {
            GroupID = catInput.data("categoryID");
            GroupID = GroupID ? GroupID : 5;
          } else {
            GroupID = 1;
          }
          return data.formData = {
            FileName: f.name,
            FileSize: f.size,
            DocTypeID: catInput.data("newval"),
            RefID: RefID,
            GroupID: GroupID,
            Description: tr.find("textarea[name='description[]']").val(),
            AccidentID: optsAccident ? optsAccident.iD : null
          };
        }).bind("fileuploaddone", function(e, data) {
          var docsContr, newDoc, newDocInAccident;
          if (data.result.success) {
            console.log("Upload result for file '" + data.files[0].name + "':");
            console.log(data.result);
            newDoc = Em.Object.create(data.result.tblDoc);
            newDocInAccident = Em.Object.create(data.result.tblDocsInAccidents);
            oDATA.GET("tblDocs").emData.pushObject(newDoc);
            oDATA.GET("tblDocsInAccidents").emData.pushObject(newDocInAccident);
            data.context.remove();
            if (!data.form.find("table tbody tr").length) {
              data.form.find(".submitButtons, table").addClass("hidden");
              docsContr = data.form.data("opts").docsController;
              return App[docsContr].refreshDocs();
            }
          } else {
            return console.log("erroras");
          }
        }).find(".fileinput-button").on("click", function() {
          return $(this).closest("form").find("table").removeClass("hidden").end().find("button.cancel").on("click", function() {
            $(this).closest("form").find(".submitButtons, table").addClass("hidden");
            console.log("Removing tr");
            console.log($(this).closest("form").find("table tbody tr"));
            return $(this).closest("form").find("table tbody tr").remove();
          });
        });
      });
    },
    _refresh: function() {
      return this._trigger("change");
    },
    _destroy: function() {
      this.changer.remove();
      return this.element.removeClass("custom-colorize").enableSelection().css("background-color", "transparent");
    }
  });

}).call(this);
